<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drexel Marketplace â€“ Messages</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/style.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bubbleBlue: "#2563eb",
            bubbleGray: "#e5e7eb",
          }
        }
      }
    };
  </script>
</head>

<body class="bg-gray-100">

  <!-- Header -->
  <div class="bg-white shadow p-4">
    <h1 class="text-2xl font-bold text-blue-800 text-center">Messages</h1>
    <p id="chat-title" class="text-center text-gray-500 mt-1"></p>
  </div>

  <!-- Main Chat Container -->
  <div class="max-w-3xl mx-auto mt-8 bg-white shadow-lg rounded-xl p-6">

  <!-- Conversations List -->
  <div id="convoList" class="mt-4 bg-white p-4 rounded-lg shadow hidden">
    <h2 class="text-xl font-semibold mb-3">Your Conversations</h2>
    <ul id="convoItems" class="space-y-2"></ul>
  </div>

    <!-- Chat Box -->
    <div id="chatBox" class="hidden mt-4 border rounded-lg p-4 h-96 overflow-y-auto bg-gray-50">
      <ul id="messages" class="space-y-2"></ul>
    </div>

    <!-- Message Input -->
    <form id="msgForm" class="hidden mt-4 flex">
      <input id="msgInput"
        class="flex-grow border p-3 rounded-l-lg"
        placeholder="Type a message...">
      <button class="bg-blue-700 text-white px-6 rounded-r-lg hover:bg-blue-800">Send</button>
    </form>
  </div>

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    let currentUser = null;
    let roomId = null;

    // Read seller ID passed from profile page
    const urlParams = new URLSearchParams(window.location.search);
    const user2 = parseInt(urlParams.get("user2"));

    // On page load
    window.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("/auth/whoami");
      const data = await res.json();

      if (!data.loggedIn) {
        alert("You must be logged in to message sellers.");
        window.location.href = "/login.html";
        return;
      }

      currentUser = data.user;

      loadConversations();

      // If user clicked "Message Seller", open that chat immediately
      if (user2 && user2 !== currentUser.id) {
        document.getElementById("chat-title").innerText =
          `Chat with User ${user2}`;

        startChatWith(user2);
      }

    });

    async function loadConversations() {
      const res = await fetch('/dm/list');
      const data = await res.json();

      const listDiv = document.getElementById("convoList");
      const list = document.getElementById("convoItems");

      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = "<li class='text-gray-500'>No conversations yet.</li>";
      } else {
        listDiv.classList.remove("hidden");

        data.forEach(c => {
          const li = document.createElement("li");
          li.className = "p-3 border rounded hover:bg-gray-100 cursor-pointer";

          li.textContent = `${c.otherUserName}`;
          li.onclick = () => startChatWith(c.otherUserId);

          list.appendChild(li);
        });
      }
  }


    // Start chat with seller
    async function startChatWith(targetId) {

      const res = await fetch(`/dmRoom?user1=${currentUser.id}&user2=${targetId}`);
      const data = await res.json();
      roomId = data.roomId;

      document.getElementById("chatBox").classList.remove("hidden");
      document.getElementById("msgForm").classList.remove("hidden");

      socket.emit("joinRoom", roomId);

      loadHistory();
    }

    // Load message history
    async function loadHistory() {
      const res = await fetch(`/history/${roomId}`);
      const history = await res.json();

      const msgList = document.getElementById("messages");
      msgList.innerHTML = "";

      history.forEach(msg => addMessageBubble(msg.sender, msg.message));
    }

    // Add a chat bubble
    function addMessageBubble(senderId, message) {
      const msgList = document.getElementById("messages");

      const item = document.createElement("li");
      const isMe = senderId == currentUser.id;

      if (isMe) {
        item.className = "flex justify-end";
        item.innerHTML = `
          <div class="max-w-xs bg-bubbleBlue text-white px-4 py-2 rounded-2xl rounded-br-none">
            ${message}
          </div>`;
      } else {
        item.className = "flex justify-start";
        item.innerHTML = `
          <div class="max-w-xs bg-bubbleGray text-gray-800 px-4 py-2 rounded-2xl rounded-bl-none">
            ${message}
          </div>`;
      }

      msgList.appendChild(item);
      msgList.scrollTop = msgList.scrollHeight;
    }

    // Sending a message
    document.getElementById("msgForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const text = document.getElementById("msgInput").value.trim();
      if (!text) return;

      socket.emit("chat message", {
        roomId,
        message: text,
        sender: currentUser.id
      });

      addMessageBubble(currentUser.id, text);
      document.getElementById("msgInput").value = "";
    });

    // Receive message from server
    socket.on("chat message", (data) => {
      if (data.sender !== currentUser.id) {
        addMessageBubble(data.sender, data.message);
      }
    });
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drexel Marketplace - Home</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Our existing stylesheet -->
    <link rel="stylesheet" href="style.css">
    <script>
        // Configuration for Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="h-full font-sans">
    <div class="flex flex-col min-h-screen">

        <!-- Header / Navigation -->
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Title -->
                    <div class="flex-shrink-0">
                        <a href="/" class="text-2xl font-bold text-blue-800">
                            Drexel Marketplace
                        </a>
                    </div>
                    
                    <!-- Dynamic User Navigation -->
                    <div id="user-nav" class="flex items-center space-x-4">
                        <!-- This will be populated by JavaScript -->
                        <div class="text-gray-500">Loading...</div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Hero Section -->
            <div class="bg-blue-800 text-white">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center">
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-4">
                        Buy & Sell at Drexel
                    </h1>
                    <p class="text-lg md:text-xl text-blue-100 mb-8 max-w-2xl mx-auto">
                        Your one-stop on-campus marketplace for textbooks, furniture, electronics, and more.
                    </p>
                    <a href="/search.html" class="bg-white text-blue-800 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition duration-300 shadow-lg">
                        Start Browsing
                    </a>
                </div>
            </div>

            <!-- Features Section -->
            <div class="bg-gray-50 py-16">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                        
                        <!-- Feature 1: Search -->
                        <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300">
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Find What You Need</h3>
                            <p class="text-gray-600 mb-6">
                                Search hundreds of listings from fellow students. Filter by category, price, and condition.
                            </p>
                            <a href="/search.html" class="text-blue-700 font-semibold hover:underline">
                                Search Listings &rarr;
                            </a>
                        </div>
                        
                        <!-- Feature 2: Sell (Logged-in only) -->
                        <div id="sell-card" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300" style="display: none;">
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Sell Your Stuff</h3>
                            <p class="text-gray-600 mb-6">
                                Have items to sell? List them in minutes and make some extra cash.
                            </p>
                            <a href="/create_post.html" class="text-blue-700 font-semibold hover:underline">
                                Create a Post &rarr;
                            </a>
                        </div>

                        <!-- Feature 3: Profile (Logged-in only) -->
                        <div id="profile-card" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300" style="display: none;">
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Your Profile</h3>
                            <p class="text-gray-600 mb-6">
                                Manage your posts, view your items, and see what you've sold.
                            </p>
                            <button onclick="goToProfile()" class="text-blue-700 font-semibold hover:underline">
                                View My Profile &rarr;
                            </button>
                        </div>

                         <!-- Feature 4: Messages (Logged-in only) -->
                        <div id="messages-card" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300" style="display: none;">
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Your Messages</h3>
                            <p class="text-gray-600 mb-6">
                                Chat directly and securely with buyers and sellers on the platform.
                            </p>
                            <a href="/dm/index.html" class="text-blue-700 font-semibold hover:underline">
                                Open Messages &rarr;
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-auto">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-500">
                &copy; 2025 Drexel Marketplace. All rights reserved.
            </div>
        </footer>
    </div>

    <script>
        let currentUserId = null;

        // Runs when the page content is loaded
        window.addEventListener('DOMContentLoaded', async () => {
            const userNav = document.getElementById('user-nav');
            const sellCard = document.getElementById('sell-card');
            const profileCard = document.getElementById('profile-card');
            const messagesCard = document.getElementById('messages-card');
            
            try {
                // Check who is logged in
                const res = await fetch('/auth/whoami');
                const data = await res.json();

                if (data.loggedIn) {
                    // --- User is LOGGED IN ---
                    currentUserId = data.user.id; // Store user ID
                    
                    // Update navigation bar
                    userNav.innerHTML = `
                        <span class="text-gray-700">Welcome, ${data.user.first_name}!</span>
                        <a href="/create_post.html" class="text-gray-600 hover:text-blue-700 font-medium">Sell</a>
                        <button onclick="goToProfile()" class="text-gray-600 hover:text-blue-700 font-medium">My Profile</button>
                        <a href="/dm/index.html" class="text-gray-600 hover:text-blue-700 font-medium">Messages</a>
                        <button onclick="logout()" class="bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-800">
                            Logout
                        </button>
                    `;
                    
                    // Show the feature cards for logged-in users
                    sellCard.style.display = 'block';
                    profileCard.style.display = 'block';
                    messagesCard.style.display = 'block';

                } else {
                    // --- User is LOGGED OUT ---
                    
                    // Update navigation bar
                    userNav.innerHTML = `
                        <a href="/login.html" class="text-gray-600 hover:text-blue-700 font-medium">Login</a>
                        <a href="/register.html" class="bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-800">
                            Register
                        </a>
                    `;
                    // Logged-out feature cards are hidden by default
                }
            } catch (err) {
                console.error('Auth check failed', err);
                userNav.innerHTML = '<a href="/login.html" class="text-red-500">Login</a>';
            }
        });

        // Function to navigate to the user's dynamic profile page
        function goToProfile() {
            if (currentUserId) {
                window.location.href = `/viewprofile/${currentUserId}`;
            } else {
                // This shouldn't happen if the button is only visible when logged in
                alert('Could not find user ID. Please log in again.');
                window.location.href = '/login.html';
            }
        }

        // Function to log the user out
        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                window.location.reload(); // Reload the homepage
            } catch (err) {
                console.error('Logout failed', err);
            }
        }
    </script>
</body>
</html>
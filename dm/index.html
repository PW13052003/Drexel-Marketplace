<!DOCTYPE html>
<html>
  <head>
    <title>Private Chat Test</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="join-area">
      <h2>Private Chat Test</h2>
      <label>Enter Room ID:</label>
      <input id="roomInput">
      <button id="joinBtn">Join Room</button>
    </div>

    <ul id="messages"></ul>
    <form id="form">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let roomId = null;
      const username = prompt("Enter your name:");

      const roomInput = document.getElementById("roomInput");
      const joinBtn = document.getElementById("joinBtn");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");

      // Join room
      joinBtn.addEventListener("click", () => {
        roomId = roomInput.value.trim();
        if (roomId) {
          socket.emit("joinRoom", roomId);
          alert(`Joined room: ${roomId}`);
        }
      });

      
      joinBtn.addEventListener("click", async () => {
        const user1 = prompt("Enter your user ID:");
        const user2 = prompt("Enter the other user's ID:");

        // Get roomId from backend
        const res = await fetch(`/dmRoom?user1=${user1}&user2=${user2}`);
        const data = await res.json();

        roomId = data.roomId;

        socket.emit("joinRoom", roomId);
        alert(`Joined private chat room: ${roomId}`);

        // Load history
        const history = await fetch(`/history/${roomId}`);
        const messagesData = await history.json();

        messages.innerHTML = ""; // clear
        messagesData.forEach((msg) => {
          const item = document.createElement("li");
          item.textContent = `${msg.sender}: ${msg.message}`;
          messages.appendChild(item);
        });
      });


      // Send chat message
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value && roomId) {
          socket.emit("chat message", { roomId, message: input.value, sender: username });
          input.value = "";
        }
      });

      // Receive chat message
      socket.on("chat message", (data) => {
        const item = document.createElement("li");
        item.textContent = `${data.sender}: ${data.message}`;
        
        // Check if the sender is the current user
        if (data.sender === username) {
          item.classList.add("my-message");
        }
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight; // Auto-scroll to bottom
      });

    </script>
  </body>
</html>
